from pathlib import Path
import textwrap

from zhenxun.configs.config import Config

PLUGIN_DIR = Path(__file__).parent
base_config = Config.get("ai_creation")


SYSTEM_PROMPT_OPTIMIZE = textwrap.dedent("""\
    你是AI绘画提示词工程师。
    任务：将用户输入转化为详细的AI绘画提示词。

    核心规则：润色时不丢失用户原文任何细节。

    【场景一：纯文本输入】
    扩展简短描述为完整场景，补充：主体特征、动作姿态、环境背景、光线效果、构图视角、艺术风格、画质要求。

    示例：
    - 输入："一只猫"
    - 输出："特写镜头，一只英国短毛猫，午后阳光下趴在木质窗台打盹，
      毛发细节清晰，光影柔和，照片级真实感，4k画质"

    【场景二：图片+文本输入】
    图片为主体，文本为修改指令。只修改文本明确提到的部分，其他元素保持原样。

    工作流程：
    1. **分析原图**：详细描述主体、姿态、构图、环境、光照、色彩、风格
    2. **解析指令**：提取具体修改要求
    3. **重构提示词**：保留未提及元素，精确应用修改指令，添加画质词

    示例：
    - 输入：[黑发女孩公园长椅微笑图] + "换成夜晚东京街头背景"
    - 输出："黑发女孩，白色连衣裙，长椅坐姿微笑表情保持不变，
      背景替换为夜晚东京街头，霓虹灯闪烁，车水马龙，光影斑驳，电影感，4k画质"

    【特殊指令】
    数量词（"四张图"、"两个版本"）和变化词（"不同的"、"多种"）需保留在提示词开头。

    【输出格式】
    严格JSON格式，使用中文：
    {
        "success": true,
        "original_prompt": "用户原始文本",
        "analysis": "意图分析",
        "optimized_prompt": "优化后的完整提示词"
    }
""")

SYSTEM_PROMPT_FUSION = textwrap.dedent("""\
    你是顶级的AI绘画提示词融合工程师。
    任务：接收一个"基础模板"和一个"用户修改指令"，将两者智能地融合成一个全新的、高质量的最终提示词。

    【核心规则】
    1.  **模板优先**: 必须完整保留基础模板中的所有核心风格、主体和场景描述。
    2.  **精确修改**: 只能根据用户的修改指令，替换或增强模板中的**相关部分**。例如，用户说"下雨天"，就只修改天气和光照，不能改变主体。
    3.  **保持画质**: 必须保留模板中关于画质、真实感、分辨率等高质量词缀。

    【输入格式说明】
    你收到的用户消息会包含`【基础模板】`和`【用户修改指令】`两部分。

    【输出格式】
    严格JSON格式，使用中文：
    {
        "success": true,
        "original_prompt": "用户原始文本",
        "analysis": "意图分析与融合过程说明",
        "optimized_prompt": "融合后优化后的完整提示词"
    }
""")

SYSTEM_PROMPT_CREATE_FROM_IMAGE = textwrap.dedent(r"""\
    你是顶级的AI绘画风格模板分析师。你的任务是分析用户提供的图片，并产出一个可复用的“图生图”风格模板。

    核心任务：提炼图片的【风格】、【氛围】和【构图】，而不是复刻具体的【内容】。

    【工作流程】
    1.  **分析图片**: 深入分析图片的以下方面：
        - **整体风格**: 是照片、油画、动漫、还是某种特定艺术风格（如赛博朋克、宫崎骏）？
        - **构图与视角**: 是特写、全身、抓拍感、还是精心设计的构图？
        - **光照与色彩**: 光源是什么（路灯、阳光），光线是柔和还是锐利，色调是暖还是冷？
        - **画质与质感**: 是否有噪点、动态模糊、胶片感、鏡头光晕等特征？
        - **后期效果**: 是否有特殊的滤镜或调色倾向？

    2.  **生成提示词 (Prompt)**:
        - **必须是通用指令**: 你的输出应该是一个指令，告诉AI如何将一个【新的主体】转化为这种风格。
        - **使用占位符**: 对于图片中的核心人物或主体，**严禁描述其具体长相、性别、发型、种族等个人特征**。必须使用泛指词汇，如 `主体人物`、`角色` 或 `输入图片中的对象`。
        - **保留可变部分**: 提示词应明确指出，主体的【姿态】、【表情】和【服装】等应保持不变，或根据输入图片进行保留。
        - **融合风格**: 将步骤1中分析出的所有风格要素，用自然流畅的中文组织成一段完整的指令式描述。

    3.  **生成模板名称**:
        - 根据提炼出的核心风格，起一个简洁、形象的模板名称（尽量在六个字以内）。

    【示例】
    - **输入图片**: 一张夜晚街头抓拍风格的女性自拍照。
    - **错误输出 (描述内容)**: "一个黑发女孩，在夜晚的街道上微笑..."
    - **正确输出 (提炼风格)**: "将输入图片中的人物转化为一张充满生活气息的夜间抓拍风格照片。保持人物的姿态和表情不变。画面模拟手持设备拍摄，有轻微的动态模糊和自然噪点。光线主要来自周围环境光，营造出柔和的光影效果。背景呈现为城市街景的散景虚化效果，整体色调偏暖，具有电影感。"

    【输出格式】
    严格按照以下JSON格式返回，不要包含任何额外的解释或代码块标记。

    {
        "success": true,
        "template_name": "（你生成的模板名称）",
        "prompt": "（你生成的图生图风格化提示词）"
    }
""")

SYSTEM_PROMPT_REFINE_TEMPLATE = textwrap.dedent("""\
    你是一位精通AI绘画提示词的优化工程师。你的任务是接收一个【基础模板】和一个【用户修改指令】，并将两者智能地融合成一个全新的、高质量的最终提示词。

    【核心规则】
    1.  **保留精髓**: 必须最大程度地保留【基础模板】中的核心风格、主体和场景描述。
    2.  **精准修改**: 只能根据【用户修改指令】，精准地替换或增强【基础模板】中的相关部分。例如，用户说“换成夜晚”，就只修改与时间和光照相关的描述，不要改变主体人物。
    3.  **智能补充**: 如果用户的指令比较模糊（如“更华丽一点”），请根据模板的上下文，对服装、背景或特效等相关元素进行合理的、创造性的增强。
    4.  **保持流畅**: 融合后的最终提示词必须是一段通顺、完整的自然语言描述。

    【输入格式】
    你将收到包含两部分内容的文本：
    - 【基础模板】: ...
    - 【用户修改指令】: ...

    【输出格式】
    严格按照以下JSON格式返回，不要包含任何额外的解释或代码块标记。

    {
        "success": true,
        "new_prompt": "（你融合并优化后的全新提示词）"
    }
""")

DEFAULT_TEMPLATES = {
    "手办": "将上传图片中的人物转化为插画中角色的1/7比例商业化手办，采用写实风格和环境。将手办放置在电脑桌上，使用无文字的圆形透明亚克力底座。在电脑屏幕上显示该手办的ZBrush建模过程。在电脑屏幕旁边放置一个BANDAI风格的玩具包装盒，上面印有原始艺术作品。",
    "巨物手办": (
        "(主体与质感): 一座宏伟的、处于建造最终阶段的巨型人物雕像，其外观和服饰完美复刻自上传的图像。雕像表面具有哑光乙烯基模型的质感，细节极其丰富。\n"
        "(互动与场景): 复杂的工业脚手架网络和平台将其完全包裹，微缩的建筑工人们正在进行最后的润色工作。地面上，工程车辆（卡车、起重机）繁忙作业。\n"
        "(环境与光影): 场景位于一个正在开发的城市中心，远处是清晰的摩天大楼天际线。时间是晴朗的午后，阳光从高处照射下来，在雕像、脚手架和地面上形成清晰、真实的阴影。全局光照效果，具有空气透视感。\n"
        "(风格与镜头): 采用低角度、广角镜头拍摄，营造出强烈的视觉冲击力和宏伟感。虚幻引擎渲染风格，8K分辨率，超高细节，电影级调色。"
    ),
    "服装拆解": (
        "专业的电子商务时尚展示柜，其中包括在干净的工作室风格的环境中展示的角色从输入图像中佩戴的衣服。 "
        "该服装分解为单个碎片（例如，顶部，底部，夹克，鞋子，配件），每件都清楚地显示在有组织的，视觉上吸引人的布局中。 "
        "每个服装项目都保留了原始图像中的确切设计，颜色，纹理以及细节，并以清晰的照明和高清清晰度展示。 背景是简约的，白色或中性的，以强调适合在线零售平台的服装细节。 "
        "演示文稿包括每个项目的微妙注释或标签，以确保磨光式的磨损和造型灵感。"
    ),
    "角色设定": (
        "\"Generate a set of character design images for me. Please create a separate and distinct image for each of the following points:\n\n"
        "*   **Proportion settings:** Show different height comparisons and the head-to-body ratio.\n"
        "*   **Three views:** One image showing the front, side, and back of the character.\n"
        "*   **Expression Sheet:** A sheet of various common facial expressions.\n"
        "*   **Pose Sheet:** A collection of various common poses.\n"
        "*   **Costume Design:** A detailed design of the character's costume.\""
    ),
    "娃娃机": "让图中的人物被关进抓娃娃机里面，双脚踩在抓娃机玻璃上，手也放在玻璃上，惊恐的表情，抓娃娃机背景是电玩城",
    "粉丝视角": (
        "**任务描述：** 描绘一个富有电影感的夜间快餐店内部场景。\n\n"
        "*   **前景 (Foreground):** 一张孤零零的桌子，上面摆放着，一个智能手机大而清晰地呈现在桌上，屏幕上清楚显示着上传的动漫/游戏角色图片。一只手正伸向食物，以此象征孤独。\n"
        "*   **中景 (Midground):** 在模糊的背景中，一对情侣并肩而坐。\n"
        "    *   其中一人是上传角色的“真人扮演版”（cosplayer）：\n"
        "        *   如果上传角色是人形，则需展示精确的cosplay，包括发型、服装和标志性道具。\n"
        "        *   如果上传角色是非人形（机甲、生物、吉祥物等），则需展示拟人化（gijinka）的cosplay演绎，其服装、颜色和道具（如盔甲部件、翅膀、耳朵、武器或标志性配饰）需清晰地带有参考图片中的视觉线索。\n"
        "    *   另一人是普通人类，他们正在表现亲密情感（亲吻、牵手或分享食物）。\n"
        "*   **背景 (Background):** 大幅玻璃窗，窗外是模糊的城市霓虹灯光。\n"
        "*   **氛围 (Mood):** 忧郁、苦乐参半、讽刺，具有电影般的浅景深效果。\n\n"
        "**[参考说明]:** 上传的图片将用于定义智能手机屏幕上的显示内容以及cosplay设计，其中可见的道具需被着重强调。"
    ),
    "发型": (
        "Based on the provided pictures, 9 different hairstyle designs are offered and output in one photo. You can zoom in on different hairstyles for display"
    ),
    "鹿": (
        "这是一张充满电影感的杰作，画质精美，拥有极强的戏剧性光影和清晰的焦点。 **核心转换要求：**\n"
        "基于用户上传的图片（无论是动物、真人还是其他形象），请将其转化为一个富有魅力的**拟人化角色**。这个新形象需要巧妙地保留原主体的核心特征——例如主色调、标志性纹理或独特元素——并将它们自然地融入到角色的服装、发型或配饰设计中。\n\n"
        "**构图与姿态指令（必须严格遵守）：**\n\n"
        "1.  **时钟位置：** 在角色的**右侧后方**，墙上挂着一个清晰、复古且尺寸适中的挂钟，钟盘上有罗马数字。\n\n"
        "2.  **金属管姿态：** 一根粗大的金属管横在角色身前，其走向**从画面左侧向着右上方的时钟方向倾斜**，形成强烈的对角线构图。\n\n"
        "3.  **握管的手：** 靠近身体下方的一只手，从上方以一个**非常标准、稳固的“正握”姿势**，牢牢抓住这根倾斜的金属管。\n\n"
        "4.  **指向的手：** 另一只手臂**向右侧高高抬起**，手臂伸展，**食指的指尖必须精准无误地指向挂钟的钟盘**。这个指向动作是画面的视觉焦点，不能有偏差。\n\n"
        "最后，请确保该拟人化角色保持**回头凝视镜头**的姿态，并维持整个场景昏暗、深沉的基调。"
    ),
    "蓝调湿发": (
        "采用细腻皮肤真实质感的风格人物的脸部特写 通过俯视的镜头进行虽现 背景为暗色 营造出暗色系且阴郁的场景氛围 人物有着散乱的湿漉漉的头发 发丝粘在脸上 不改变原片发色 眼睛神胧 其中带着危险和眷念的情绪 尽量腹黑高冷的气质 画面着句勒了人物的面部细节 高先处理十分讲究 同时画面虽然出现摄影机极蓝光噪点的画质 并且有着强烈的蓝白色曝光效果 原比例"
    ),
    "抓拍": (
        "将插画风格的人物转化为高度真实的照片效果，模拟iPhone自拍的随性风格。画面需呈现以下特征： 构图：避免刻意摆拍，主体不突出、无中心构图，模仿手持手机时无意间抓拍的松散感。\n"
        "画质：轻微动态模糊（如手臂移动或转身时的残影），低锐度，适当添加噪点以匹配手机夜拍质感。\n"
        "光线：仅依赖路灯的漫射光，避免均匀打光，保留明暗过渡的自然阴影。\n"
        "比例：严格保持9:16竖版比例，符合手机屏幕尺寸。\n"
        "去AI感：杜绝完美对称、超现实细节或过度平滑的皮肤纹理，需模拟真人拍摄的瑕疵（如镜头炫光、焦点不实）。\n"
        "关键细节：\n"
        "背景建议为街道、室内玄关等生活化场景，避免纯色或虚拟布景。\n"
        "人物表情放松（如低头看手机、侧脸回眸等），衣着为图片衣服。\n"
        "添加轻微镜头畸变或iPhone特有的HDR色调倾向。"
    ),
}

DOUBAO_SELECTORS = {
    "file_upload": [
        'input[type="file"]',
        'input[accept*="image"]',
        'input[accept*="image/*"]',
    ],
    "prompt_input": [
        "[contenteditable='true']",
        "textarea",
        "input[type='text']",
        'textarea[placeholder*="描述"]',
        'textarea[placeholder*="输入"]',
        'input[placeholder*="描述"]',
        'input[placeholder*="输入"]',
        ".input-area textarea",
        ".prompt-input",
    ],
}
